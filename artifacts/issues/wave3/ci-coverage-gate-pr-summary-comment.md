## [CI] Coverage Gate + PR Summary Comment

Generated automatically from backlog/wave3.yaml on 2025-10-15T23:23:09-07:00 (America/Phoenix · no DST).

## Context
This task originates from the Wave 3 Mission Outline Plan generated from YAML. Honor America/Phoenix (no DST) for all scheduling data and reference the Decision/Note/Action markers when updating artifacts.

## Acceptance Criteria (from issue)
- pytest-cov ≥70% on touched code; build fails otherwise.
- PR comment posts coverage summary.

## Return these 5 outputs
1. Implementation plan covering sequencing and Phoenix-aware timestamps.
2. Code snippets or diffs that satisfy the acceptance criteria.
3. Tests (unit/pytest) demonstrating coverage.
4. Documentation updates referencing this wave's artifacts.
5. Risk assessment noting fallbacks and rollback steps.

### Diff-oriented implementation plan
- Introduce a reusable coverage gate script under `tools/coverage_gate.py` that parses `.coverage` or `coverage.xml` generated by pytest-cov.
- Update `pyproject.toml` or `pytest.ini` to enforce `--cov` defaults, ensuring touched files reach ≥70%; add invocation within existing CI pipeline scripts (e.g., `scripts/ci/run_pytest.sh`).
- Extend GitHub PR automation (likely `actions/pr_commenter/`) to call a new helper `src/releasecopilot/utils/coverage_comment.py` that formats a Markdown summary for posting to PR threads.
- Ensure Phoenix timestamp metadata is included if the comment references build times (use `ZoneInfo("America/Phoenix")`).
- Sequence: add coverage gate script → wire pytest config → implement PR comment helper → update CI script to call helper and fail on threshold → document/test.

### Key code snippets
```python
# tools/coverage_gate.py
from __future__ import annotations

import json
from pathlib import Path


def enforce_threshold(report: Path, minimum: float = 70.0) -> float:
    """Return total coverage percentage and raise if below the minimum.

    The report must be generated deterministically (`coverage xml`). The
    function logs only aggregate stats—never file contents or secrets.
    """

    data = json.loads(report.read_text())
    percent = float(data["totals"]["percent_covered_display"])
    if percent < minimum:
        raise SystemExit(f"Coverage {percent:.1f}% is below required {minimum:.1f}%")
    return percent
```

```python
# src/releasecopilot/utils/coverage_comment.py
from datetime import datetime
from zoneinfo import ZoneInfo


def build_comment(coverage: float, *, tz: ZoneInfo | None = None) -> str:
    """Create the deterministic PR summary comment for coverage results."""

    zone = tz or ZoneInfo("America/Phoenix")
    timestamp = datetime.now(tz=zone).strftime("%Y-%m-%d %H:%M:%S %Z")
    return f"Coverage: {coverage:.1f}% (threshold 70%). Checked at {timestamp}."
```

```diff
# scripts/ci/run_pytest.sh
@@
pytest --cov=src --cov=clients --cov-report=json:coverage.json "$@"
python tools/coverage_gate.py coverage.json
python -m releasecopilot.cli pr-comment coverage --file coverage.json
```

### Tests (pytest; no live network)
- `tests/utils/test_coverage_gate.py::test_enforce_threshold_passes_and_returns_value` uses temp JSON fixtures.
- `tests/utils/test_coverage_gate.py::test_enforce_threshold_raises_below_threshold` asserts `SystemExit`.
- `tests/utils/test_coverage_comment.py::test_build_comment_uses_phoenix_timezone` patches datetime to ensure deterministic output.
- Mock PR commenter integration in `tests/cli/test_pr_comment.py::test_coverage_comment_command_posts_markdown` verifying comment body.
- Ensure coverage for new utils >90% and overall touched modules ≥70% when running `pytest --cov` locally.

### Docs excerpt (README/runbook)
Add to `docs/runbooks/ci.md`:

> Pytest now produces `coverage.json` and enforces a ≥70% threshold using `tools/coverage_gate.py`. The gate runs in CI and locally via `make test`. Coverage summaries post to PR threads stamped in America/Phoenix to align with release schedules.

Update `README.md` contributing section:

> Before opening a PR, run `pytest --cov --cov-report=json:coverage.json` followed by `python tools/coverage_gate.py coverage.json` to mimic CI gating and avoid failures.

### Risk & rollback
- Risks: coverage parsing incompatibilities when report schema changes; CI secrets accidentally logged in comments; timezone mismatch causing ambiguous timestamps.
- Rollback: remove `tools/coverage_gate.py`, revert CI script and PR commenter wiring; disable comment command invocation.
- No data migrations or dependency updates involved.


## Critic Check
- Re-read the acceptance criteria.
- Confirm Phoenix timezone is referenced wherever scheduling appears.
- Ensure no secrets or credentials are exposed.
- Verify pytest-cov produces deterministic JSON; run ruff/black/mypy after wiring the gate.
- Confirm PR commenter posts only aggregate metrics and redacts repo paths if needed.
- Ensure coverage gate fails locally when threshold unmet.

## PR Markers
- Begin change logs with **Decision:**/**Note:**/**Action:** blocks.
- Link back to the generated manifest entry for traceability.
- **Decision:** Enforce ≥70% pytest-cov threshold and publish Phoenix-stamped PR summaries.
- **Note:** Contributors must run the gate locally to prevent CI failures.
- **Action:** Add coverage gate script, update CI runner, and integrate PR coverage comment command.

**Labels:** wave:wave3, mvp, area:ci, priority:medium
